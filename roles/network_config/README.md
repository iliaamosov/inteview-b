Описание
Эта роль находит, переименовывает и активирует основной сетевой интерфейс

Выполняются следующие задачи:

- Определение активного сетевого интерфейса
- Переименование интерфейса в net0
- Активация переименованного интерфейса
- Проверка работы сети после переименования




Структура выполнения



1. Получение списка активных сетевых интерфейсов

Выполняем команду:

ip -o link show | awk -F': ' '$2 !~ /^lo$/ {print $2}' | cut -d' ' -f1



Что тут и зачем:
ip -o link show объяснять не нужно

-F': '  - разделитель 
$2 !~ /^lo$/ -если второй столбец ($2) НЕ начинается с lo, выполняем действие
{print $2}  - выводим второй столбец
-d' ' -  разделитель 
-f1 -  берем только первый столбец.

например вывод 
eth0
wlan0


первоначально делал версию попроще. 
ip -o link show | grep -v " lo:" | cut -d':' -f2 | awk '{print $1}'

но она не ловила enX0 (надеюсь, что это не ловушка, чтобы усложнить)






2. Вывод найденных интерфейсов

debug:
  var: net_interfaces.stdout_lines

Если список пустой, значит интерфейсов нет


3. Проверка наличия активных интерфейсов

Если интерфейсов нет, выводим ошибку и останавливаем плейбук.

fail:
  msg: "Ошибка: не найдены активные сетевые интерфейсы!"

Когда выполняется:
Если net_interfaces.stdout_lines | length == 0.


4. Переименование интерфейса в net0


Если найден интерфейс отличный от net0, переименовываем его.
ip link set <интерфейс> name net0

Когда выполняется:
Если net_interfaces.stdout_lines[0] != "net0".




5. Включение  интерфейса net0

ip link set net0 up




6. Проверка поднят ли интерфейс net0

ip a show net0 | grep 'state UP' || ip link set net0 up

Если интерфейс не включен, он активируется.


7. Получение информации о net0

ip a show net0
Результат сохраняется в net0_info.


8. Вывод деталей интерфейса net0

debug:
  msg: "{{ net0_info.stdout_lines }}"




Запуск роли

ansible-playbook -i inventory/hosts.ini playbook.yml --tags network_config
ansible-playbook -i inventory/hosts.ini playbook.yml --tags network_config --check

